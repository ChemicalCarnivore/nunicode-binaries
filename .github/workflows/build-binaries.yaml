name: Build for Multiple Platforms

on:
  workflow_dispatch:
  workflow_call:

jobs:
  build:
    name: Build Binaries
    strategy:
      matrix:
        platform: [linux-x64, linux-arm64, win-x64, osx-arm64]
        include:
          - platform: linux-x64
            compiler: gcc-x86-64-linux-gnu
            toolchain: Toolchain-Amd64.cmake
            lib-suffix: so
            os: ubuntu-latest
          - platform: linux-arm64
            compiler: gcc-aarch64-linux-gnu
            toolchain: Toolchain-Arm64.cmake
            lib-suffix: so
            os: ubuntu-latest
          - platform: win-x64
            compiler: gcc-mingw-w64-x86-64
            toolchain: Toolchain-Mingw64.cmake
            lib-suffix: dll
            os: ubuntu-latest
          - platform: osx-arm64
            toolchain: Toolchain-Mac64.cmake
            lib-suffix: dylib
            os: macos-latest
    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout this repository (nunicode-binaries)
      uses: actions/checkout@v4

    - name: Set up dependencies
      if: matrix.os == 'ubuntu-latest'
      run: sudo apt-get update

    - name: Install cross-compilers and dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get install -y \
          ${{ matrix.compiler }} \
          cmake

    - name: Checkout nunicode repository from Bitbucket (specific tag)
      run: |
        git clone https://bitbucket.org/alekseyt/nunicode.git
        cd nunicode
        git checkout 1.11

    - name: Copy cmake file and toolchain files from this repository
      run: |
        cp cmake/* nunicode/cmake/
        cp -f CMakeLists.txt nunicode/
        mkdir -p nunicode/include

    - name: Copy sqlite include files from their respective locations
      run: cp ${{ matrix.os == 'ubuntu-latest' && '/usr/include' || '/opt/homebrew/opt/sqlite/include' }}/sqlite3*.h nunicode/include/

    - name: Build for ${{ matrix.platform }}
      run: |
        cd nunicode/staging
        mkdir -p build_${{ matrix.platform }}
        (cd build_${{ matrix.platform }} && cmake ../.. -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=../../cmake/${{ matrix.toolchain }})
        (cd build_${{ matrix.platform }} && make VERBOSE=1 nusqlite3)

    - name: Check the cmake cache file and lipo info
      if: matrix.os == 'macos-latest' && matrix.platform == 'osx-arm64'
      run: |
        cat nunicode/staging/build_${{ matrix.platform }}/CMakeCache.txt
        lipo -info nunicode/staging/build_${{ matrix.platform }}/sqlite3/libnusqlite3.dylib

    - name: Upload binaries for ${{ matrix.platform }}
      uses: actions/upload-artifact@v4
      with:
        name: libnusqlite3-${{ matrix.platform }}
        path: nunicode/staging/build_${{ matrix.platform }}/sqlite3/libnusqlite3.${{ matrix.lib-suffix }}
